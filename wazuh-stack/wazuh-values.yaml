# =============================================================================
# Wazuh Helm Values para ZCloud (k3s híbrido)
# Chart: morgoved/wazuh-helm v1.0.9
# URL: https://artifacthub.io/packages/helm/wazuh-helm-morgoved/wazuh
# =============================================================================
# IMPORTANTE: Wazuh NO tiene imágenes ARM64, todo debe correr en 'lake' (x86_64)
# Storage: nfs-shared (NFS desde raspberry 10.10.0.2)
# =============================================================================

# --- Cert-manager (para certificados internos TLS) ---
# Si ya tienes cert-manager instalado en el cluster, déjalo deshabilitado
cert-manager:
  enabled: false

# Usar cert-manager existente para generar certificados autofirmados internos
certificates:
  enabled: true
  issuer:
    name: null  # Creará un issuer selfsigned automáticamente
    type: issuer
  duration: 2160h    # 90 días
  renewBefore: 360h  # Renovar 15 días antes

# =============================================================================
# WAZUH INDEXER (OpenSearch)
# =============================================================================
indexer:
  enabled: true
  
  # Single node para setup pequeño
  replicas: 1
  
  # ⚠️ CRÍTICO: Forzar a nodo x86_64
  nodeSelector:
    kubernetes.io/hostname: lake
  
  images:
    repository: wazuh/wazuh-indexer
    tag: "4.14.1"
    pullPolicy: IfNotPresent
  
  # Recursos ajustados para Intel N150
  resources:
    requests:
      cpu: 300m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
  
  # JVM heap (debe ser ~50% de memory limit)
  env:
    OPENSEARCH_JAVA_OPTS: "-Xms1g -Xmx1g -Dlog4j2.formatMsgNoLookups=true"
    CLUSTER_NAME: "wazuh"
    NETWORK_HOST: "0.0.0.0"
    DISABLE_INSTALL_DEMO_CONFIG: "true"

  # Extra environment variables from Secret
  extraEnv:
    - name: INDEXER_PASSWORD
      valueFrom:
        secretKeyRef:
          name: wazuh-credentials
          key: indexer-password
    - name: INDEXER_PASSWORD_HASH
      valueFrom:
        secretKeyRef:
          name: wazuh-credentials
          key: indexer-password-hash
  
  # Storage NFS
  storageClass: nfs-shared
  storageSize: 50Gi
  
  # Servicio interno
  service:
    type: ClusterIP
    httpPort: 9200
    nodes: 9300
    metrics: 9600
  
  # Credenciales del indexer (admin)
  # Para generar el hash:
  # docker run --rm -ti wazuh/wazuh-indexer:4.14.1 bash /usr/share/wazuh-indexer/plugins/opensearch-security/tools/hash.sh
  # NOTA: Las credenciales se obtienen del Secret wazuh-credentials
  cred:
    password: null  # Se obtiene de INDEXER_PASSWORD via extraEnv
    passwordHash: null  # Se obtiene de INDEXER_PASSWORD_HASH via extraEnv
  
  # Deshabilitar PDB para single node
  pdb:
    enabled: false
  
  # Network policy (permitir tráfico interno)
  networkPolicy:
    enabled: false  # Simplificar para debug inicial

# =============================================================================
# WAZUH MANAGER (Master + Workers)
# =============================================================================
wazuh:
  enabled: true
  
  # CRÍTICO: Forzar a nodo x86_64
  nodeSelector:
    kubernetes.io/hostname: lake
  
  # Clave del cluster (cambiar en producción)
  # NOTA: Se obtiene del Secret wazuh-credentials
  key: null  # Usar envFrom con secretKeyRef
  
  syslog_enable: true
  
  images:
    repository: wazuh/wazuh-manager
    tag: "4.14.1"
    pullPolicy: IfNotPresent
  
  # Variables de entorno
  env:
    FILEBEAT_SSL_VERIFICATION_MODE: full

  # Extra environment variables from Secret
  extraEnv:
    - name: WAZUH_CLUSTER_KEY
      valueFrom:
        secretKeyRef:
          name: wazuh-credentials
          key: cluster-key
    - name: WAZUH_API_USER
      valueFrom:
        secretKeyRef:
          name: wazuh-credentials
          key: api-username
    - name: WAZUH_API_PASSWORD
      valueFrom:
        secretKeyRef:
          name: wazuh-credentials
          key: api-password
    - name: WAZUH_AUTHD_PASS
      valueFrom:
        secretKeyRef:
          name: wazuh-credentials
          key: agent-enrollment-password
  
  # Credenciales API (para dashboard y agentes)
  # La password DEBE tener: mayúscula, minúscula, número y símbolo (.*+?-)
  # NOTA: Se obtienen del Secret wazuh-credentials
  apiCred:
    username: null  # Usar envFrom con secretKeyRef
    password: null  # Usar envFrom con secretKeyRef 
  
  # Password para registro de agentes
  # NOTA: Se obtiene del Secret wazuh-credentials
  authd:
    enabled: true
    pass: null  # Usar envFrom con secretKeyRef
  
  # --- Master ---
  master:
    enabled: true
    
    resources:
      requests:
        cpu: 300m
        memory: 512Mi
      limits:
        cpu: 800m
        memory: 1Gi
    
    service:
      type: ClusterIP
    
    # Storage NFS
    storageClass: nfs-shared
    storageSize: 20Gi
    
    networkPolicy:
      enabled: false
  
  # --- Workers (deshabilitados para setup pequeño) ---
  worker:
    enabled: false
    replicas: 0

# =============================================================================
# WAZUH DASHBOARD
# =============================================================================
dashboard:
  enabled: true
  replicas: 1
  
  # ⚠️ CRÍTICO: Forzar a nodo x86_64
  nodeSelector:
    kubernetes.io/hostname: lake
  
  images:
    repository: wazuh/wazuh-dashboard
    tag: "4.14.1"
    pullPolicy: IfNotPresent
  
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  
  # SSL interno deshabilitado (Traefik maneja TLS externo)
  enable_ssl: false

  # Extra environment variables from Secret
  extraEnv:
    - name: KIBANASERVER_USER
      valueFrom:
        secretKeyRef:
          name: wazuh-credentials
          key: dashboard-username
    - name: KIBANASERVER_PASSWORD
      valueFrom:
        secretKeyRef:
          name: wazuh-credentials
          key: dashboard-password
    - name: KIBANASERVER_PASSWORD_HASH
      valueFrom:
        secretKeyRef:
          name: wazuh-credentials
          key: dashboard-password-hash
  
  # Credenciales dashboard (kibanaserver)
  # NOTA: Se obtienen del Secret wazuh-credentials
  cred:
    username: null  # Usar envFrom con secretKeyRef
    password: null  # Usar envFrom con secretKeyRef
    passwordHash: null  # Usar envFrom con secretKeyRef
  
  service:
    type: ClusterIP
    httpPort: 5601
  
  # --- Ingress para Traefik ---
  ingress:
    enabled: true
    className: "traefik"
    host: "wazuh.zyrak.cloud"
    annotations:
      traefik.ingress.kubernetes.io/router.entrypoints: websecure
      traefik.ingress.kubernetes.io/router.tls: "true"
      cert-manager.io/cluster-issuer: letsencrypt-prod
    tls:
      - secretName: wazuh-dashboard-tls
        hosts:
          - wazuh.zyrak.cloud
  
  networkPolicy:
    enabled: false
  
  pdb:
    enabled: false

# =============================================================================
# WAZUH AGENT (DaemonSet)
# =============================================================================
# NOTA: El agente de Wazuh SÍ tiene imagen ARM64 (wazuh/wazuh-agent:4.14.1)
# Pero para empezar, solo lo desplegamos en x86_64
agent:
  enabled: false  # Habilitar después de que el stack funcione
  
  # Cuando lo habilites, puedes elegir:
  # Opción A: Solo en lake (x86_64)
  # nodeSelector:
  #   kubernetes.io/hostname: lake
  
  # Opción B: En todos los nodos (si la imagen ARM funciona)
  # nodeSelector: {}
  # tolerations:
  #   - operator: Exists  # Tolerar todos los taints
  
  images:
    repository: wazuh/wazuh-agent
    tag: "4.14.1"
    pullPolicy: IfNotPresent
  
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

# =============================================================================
# CONFIGURACIÓN EXTERNA (no usar)
# =============================================================================
externalIndexer:
  enabled: false